---
import { getCollection, render } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ResourceLink from '../../components/ResourceLink.astro';
import ObjectivesList from '../../components/ObjectivesList.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import Quiz from '../../components/Quiz';

// Module grouping for sub-module numbering
const moduleGroupRanges = [
  { number: 1, title: "Foundations of AI", start: 1, end: 3 },
  { number: 2, title: "Improving Productivity with AI", start: 4, end: 7 },
  { number: 3, title: "Finding the Right AI Opportunities", start: 8, end: 10 },
  { number: 4, title: "Shipping AI Features", start: 11, end: 12 },
];

function getModuleLabel(moduleNum: number) {
  const group = moduleGroupRanges.find(g => moduleNum >= g.start && moduleNum <= g.end);
  if (!group) return `Module ${moduleNum}`;
  const subNum = moduleNum - group.start + 1;
  return `Module ${group.number} · Lesson ${subNum}`;
}

function getModuleGroupTitle(moduleNum: number) {
  const group = moduleGroupRanges.find(g => moduleNum >= g.start && moduleNum <= g.end);
  return group ? group.title : '';
}

export async function getStaticPaths() {
  const modules = await getCollection('modules', ({ data }) => data.course === 3);
  const allModules = modules.map(m => ({
    slug: m.slug,
    title: m.data.title,
    module: m.data.module,
  }));
  return modules.map((module) => ({
    params: { slug: module.slug.replace('course-3/', '') },
    props: { module, allModules },
  }));
}

const { module, allModules } = Astro.props;
const { Content, headings } = await render(module);
const { title, description, objectives, resources, quiz } = module.data;
const moduleLabel = getModuleLabel(module.data.module);
const groupTitle = getModuleGroupTitle(module.data.module);

// Filter to only lessons within the same module group
const currentGroup = moduleGroupRanges.find(g => module.data.module >= g.start && module.data.module <= g.end);
const groupModules = currentGroup
  ? allModules.filter(m => m.module >= currentGroup.start && m.module <= currentGroup.end)
  : allModules;
---

<Layout title={title} description={description}>
  <div class="max-w-6xl mx-auto px-4 md:px-8 py-12">
    <nav class="mb-8">
      <a href="/ai-bootcamp-pages/course-3/" class="text-blue-600 hover:text-blue-800">&larr; Back to All Modules</a>
    </nav>

    <header class="mb-8">
      <span class="text-sm font-medium text-gray-500">{moduleLabel} — {groupTitle}</span>
      <h1 class="text-3xl md:text-4xl font-bold text-[--propel-navy] mt-1 mb-4">{title}</h1>
      <p class="text-lg text-gray-600">{description}</p>
    </header>

    <ObjectivesList objectives={objectives} />

    <div class="flex gap-8">
      <TableOfContents
        headings={headings}
        modules={groupModules}
        currentSlug={module.slug}
        courseNumber={3}
        groupTitle={groupTitle}
      />

      <div class="min-w-0 flex-1">
        <article class="prose mb-10">
          <Content />
        </article>

        {resources && resources.length > 0 && (
          <section class="mb-10">
            <h2 class="text-xl font-semibold text-[--propel-navy] mb-4">Resources</h2>
            <div class="space-y-3">
              {resources.map((resource) => (
                <ResourceLink title={resource.title} url={resource.url} type={resource.type} />
              ))}
            </div>
          </section>
        )}

        {quiz && quiz.length > 0 && (
          <section class="mb-10">
            <h2 class="text-xl font-semibold text-[--propel-navy] mb-4">Check Your Understanding</h2>
            <Quiz client:load questions={quiz} moduleId={`course-3-${module.slug}`} />
          </section>
        )}
      </div>
    </div>
  </div>
</Layout>
