---
interface ModuleInfo {
  slug: string;
  title: string;
  module: number;
}

interface Props {
  headings: { depth: number; slug: string; text: string }[];
  modules: ModuleInfo[];
  currentSlug: string;
  courseNumber: number;
  groupTitle?: string;
}

const { headings, modules, currentSlug, courseNumber, groupTitle } = Astro.props;
const toc = headings.filter(h => h.depth >= 2 && h.depth <= 3);
const sortedModules = [...modules].sort((a, b) => a.module - b.module);
const basePath = `/ai-bootcamp-pages/course-${courseNumber}`;
---

<nav class="hidden lg:block w-56 shrink-0">
  <div class="sticky top-24 max-h-[calc(100vh-8rem)] overflow-y-auto">
    <!-- Course Modules -->
    <div class="mb-6">
      <h4 class="text-sm font-semibold text-propel-navy mb-3">{groupTitle || `Course ${courseNumber}`}</h4>
      <ul class="space-y-1">
        {sortedModules.map(m => {
          const isActive = m.slug === currentSlug;
          const href = `${basePath}/${m.slug.replace(`course-${courseNumber}/`, '')}/`;
          return (
            <li>
              <a
                href={href}
                class:list={[
                  "block py-1.5 px-3 text-sm rounded-md transition-colors",
                  isActive
                    ? "bg-propel-blue/10 text-propel-blue font-medium"
                    : "text-gray-600 hover:text-propel-navy hover:bg-gray-100"
                ]}
              >
                {m.module}. {m.title}
              </a>
            </li>
          );
        })}
      </ul>
    </div>

    <!-- On This Page TOC -->
    {toc.length > 0 && (
      <div class="pt-4 border-t border-gray-200">
        <h4 class="text-sm font-semibold text-propel-navy mb-3">On this page</h4>
        <ul class="space-y-1 border-l border-gray-200">
          {toc.map(h => (
            <li>
              <a
                href={`#${h.slug}`}
                data-heading={h.slug}
                class:list={[
                  "toc-link block py-1 text-sm transition-colors",
                  h.depth === 3 ? "pl-6" : "pl-4"
                ]}
              >
                {h.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    )}
  </div>
</nav>

<script>
  function initScrollSpy() {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('article h2[id], article h3[id]');

    if (headings.length === 0 || tocLinks.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            // Remove active from all links
            tocLinks.forEach((link) => link.classList.remove('active'));
            // Add active to current
            const activeLink = document.querySelector(`.toc-link[data-heading="${entry.target.id}"]`);
            activeLink?.classList.add('active');
          }
        });
      },
      {
        rootMargin: '-80px 0px -70% 0px',
      }
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  // Run on initial load
  initScrollSpy();

  // Re-run on Astro page transitions (View Transitions)
  document.addEventListener('astro:page-load', initScrollSpy);
</script>
